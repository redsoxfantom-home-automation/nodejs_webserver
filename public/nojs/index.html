<html lang="en">
   <head>
      <title>Lights</title>
   </head>
   <body>
      <button onclick="requestLights()">Refresh</button>

      <ul id="lightList"/>

      <script>
         var lightMap = {}
         
         function toggleLight(lightId)
         {
            lightData = {
               id : lightId,
               power : !lightMap[lightId].power
            }
            lightDataString = JSON.stringify(lightData)

            httpFunc(
               '/lights',
               'POST',
               function(resp) {
                  requestLights()
               },
               lightDataString
            );
         }

         function requestLights()
         {
            httpFunc(
               '/lights',
               'GET',
               function(resp) {
                  populateLights(resp)
               },
               null
            );
         }

         function populateLights(lightsJson)
         {
            obj = JSON.parse(lightsJson);
            lightList = document.getElementById('lightList');
            lightList.innerHTML = '';
   
            for(i = 0; i < obj.length; i++)
            {
               light = obj[i];
               lightMap[light.id] = light;
               li = document.createElement('li');
               powerString = light.power? 'ON' : 'OFF'
               togglePower = '<button onclick="toggleLight('+light.id+')">Toggle Light</button>'
               li.innerHTML = 'NAME: "' + light.label + '" POWER: ' + powerString + "  " + togglePower;
               lightList.appendChild(li);
            }
         }

         function httpFunc(url,reqType,callback,data)
         {
            console.log("Sending "+reqType+" to url "+url+" with data "+data)

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
               if(xmlHttp.readyState === 4 && xmlHttp.status === 200)
               {
                  callback(xmlHttp.responseText);
               }
            }
            xmlHttp.open(reqType,url,true);
            xmlHttp.send(data);
         }
      </script>
   </body>
</html>
